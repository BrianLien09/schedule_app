# Firestore Security Rules è¨­å®šæŒ‡å—

æœ¬æ–‡ä»¶èªªæ˜å¦‚ä½•è¨­å®š Firestore å®‰å…¨è¦å‰‡ï¼Œå¯¦ç¾ã€Œç™½åå–®æˆå“¡å…±ç”¨è³‡æ–™ã€çš„æ¬Šé™æ§åˆ¶ã€‚

---

## ğŸ“‹ è¦å‰‡èªªæ˜

### æ¬Šé™æ¶æ§‹

```
ç™½åå–®æˆå“¡ï¼ˆåœ¨ Firestore Rules ä¸­è¨­å®šï¼‰
â”œâ”€ å¯ä»¥è®€å–æ‰€æœ‰å…±ç”¨è³‡æ–™
â”œâ”€ å¯ä»¥æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤è³‡æ–™
â””â”€ è³‡æ–™å„²å­˜åœ¨ /shared/ è·¯å¾‘ä¸‹ï¼ˆæ‰€æœ‰äººå…±ç”¨ï¼‰

æœªæˆæ¬Šä½¿ç”¨è€…
â””â”€ ç„¡æ³•è®€å–ä»»ä½•è³‡æ–™ï¼ˆFirestore ç›´æ¥æ‹’çµ•ï¼‰
```

### è³‡æ–™çµæ§‹

```
Firestore Database
â””â”€â”€ /shared (collection)
    â””â”€â”€ /data (document)
        â”œâ”€â”€ /courses (sub-collection) - èª²ç¨‹è³‡æ–™
        â”œâ”€â”€ /workShifts (sub-collection) - æ‰“å·¥ç­è¡¨
        â”œâ”€â”€ /events (sub-collection) - é‡è¦äº‹ä»¶
        â””â”€â”€ /salaryRecords (sub-collection) - è–ªè³‡è¨˜éŒ„
```

**é‡è¦**ï¼šFirestore è·¯å¾‘å¿…é ˆæ˜¯**å¶æ•¸æ®µ**ï¼ˆcollection/document/collection/document...ï¼‰ï¼Œæ‰€ä»¥ä½¿ç”¨ `/shared/data/{collection}` è€Œä¸æ˜¯ `/shared/{collection}`ã€‚

---

## ğŸ”§ è¨­å®šæ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæº–å‚™ Email æ¸…å–®

æ”¶é›†æ‰€æœ‰éœ€è¦å­˜å–æ‡‰ç”¨ç¨‹å¼çš„å®¶åº­æˆå“¡çš„ Gmail åœ°å€ã€‚

**ç¯„ä¾‹**ï¼š
- `mom@gmail.com`
- `dad@gmail.com`
- `brian@gmail.com`
- `sister@gmail.com`

### æ­¥é©Ÿ 2ï¼šå‰å¾€ Firebase Console è¨­å®šè¦å‰‡

1. é–‹å•Ÿ [Firebase Console](https://console.firebase.google.com/)
2. é¸æ“‡ä½ çš„å°ˆæ¡ˆ
3. å·¦å´é¸å–® â†’ **Firestore Database**
4. é»é¸é ‚éƒ¨çš„ã€Œ**è¦å‰‡**ã€åˆ†é 
5. å°‡ä»¥ä¸‹è¦å‰‡è²¼ä¸Šï¼ˆè¨˜å¾—æ›¿æ› email æ¸…å–®ï¼‰ï¼š

```javascript
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // === å…±ç”¨è³‡æ–™è·¯å¾‘ ===
    match /shared/{document=**} {
      // 1. å¿…é ˆç™»å…¥ (request.auth != null)
      // 2. Email å¿…é ˆåœ¨ç™½åå–®å…§
      allow read, write: if request.auth != null && 
          request.auth.token.email in [
              'mom@gmail.com',     // æ›¿æ›ç‚ºå¯¦éš›çš„ Email
              'dad@gmail.com',     // æ›¿æ›ç‚ºå¯¦éš›çš„ Email
              'brian@gmail.com',   // æ›¿æ›ç‚ºå¯¦éš›çš„ Email
              'sister@gmail.com'   // æ›¿æ›ç‚ºå¯¦éš›çš„ Email
          ];
    }
    
    // === ç¦æ­¢å­˜å–å…¶ä»–è·¯å¾‘ ===
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

### æ­¥é©Ÿ 3ï¼šæ›¿æ›å¯¦éš›å€¼

å°‡è¦å‰‡ä¸­çš„ email æ¸…å–®æ›¿æ›ç‚ºä½ çš„å®¶äººå¯¦éš›çš„ Gmail åœ°å€ã€‚

**æ³¨æ„äº‹é …**ï¼š
- Email å¿…é ˆèˆ‡ Google ç™»å…¥æ™‚çš„ email å®Œå…¨ä¸€è‡´
- Email å¤§å°å¯«ä¸æ•æ„Ÿ
- æ¯å€‹ email ç”¨é€—è™Ÿåˆ†éš”
- æœ€å¾Œä¸€å€‹ email å¾Œé¢ä¸è¦åŠ é€—è™Ÿ

### æ­¥é©Ÿ 4ï¼šç™¼å¸ƒè¦å‰‡

1. é»é¸ã€Œ**ç™¼å¸ƒ**ã€æŒ‰éˆ•
2. ç¢ºèªç™¼å¸ƒ
3. è¦å‰‡æœƒç«‹å³ç”Ÿæ•ˆï¼ˆç„¡éœ€é‡æ–°éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼ï¼‰

---

## âœ… é©—è­‰è¦å‰‡

### æ¸¬è©¦ç™½åå–®æˆå“¡

1. ä½¿ç”¨ç™½åå–®ä¸­çš„ Google å¸³è™Ÿç™»å…¥
2. å˜—è©¦æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤è³‡æ–™
3. **é æœŸçµæœ**ï¼šæ‰€æœ‰æ“ä½œéƒ½æˆåŠŸ

### æ¸¬è©¦æœªæˆæ¬Šä½¿ç”¨è€…

1. ä½¿ç”¨ä¸åœ¨ç™½åå–®ä¸­çš„ Google å¸³è™Ÿç™»å…¥
2. **é æœŸçµæœ**ï¼š
   - å¯ä»¥ç™»å…¥ï¼Œä½†çœ‹ä¸åˆ°ä»»ä½•è³‡æ–™
   - Firestore æœƒæ‹’çµ•å­˜å–
   - ç€è¦½å™¨ Console æœƒé¡¯ç¤º `permission-denied` éŒ¯èª¤

---

## ğŸ” å¸¸è¦‹å•é¡Œ

### Q1: å¦‚ä½•æ–°å¢æˆ–ç§»é™¤å®¶äººï¼Ÿ

ä¿®æ”¹è¦å‰‡ä¸­çš„ email æ¸…å–®ï¼Œç„¶å¾Œé‡æ–°ç™¼å¸ƒè¦å‰‡å³å¯ï¼š

```javascript
allow read, write: if request.auth != null && 
    request.auth.token.email in [
        'new.family@gmail.com',  // æ–°å¢çš„å®¶äºº
        'existing@gmail.com'
    ];
```

### Q2: æ¯å€‹äººçš„è³‡æ–™æ˜¯åˆ†é–‹çš„å—ï¼Ÿ

ä¸æ˜¯ã€‚**æ‰€æœ‰ç™½åå–®æˆå“¡å…±ç”¨åŒä¸€ä»½è³‡æ–™**ï¼Œå„²å­˜åœ¨ `/shared/data/` è·¯å¾‘ä¸‹ã€‚æ‰€æœ‰äººéƒ½å¯ä»¥è®€å¯«åŒä¸€ä»½èª²è¡¨ã€ç­è¡¨å’Œè–ªè³‡è¨˜éŒ„ã€‚

### Q3: è¦å‰‡è®Šæ›´éœ€è¦é‡æ–°éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼å—ï¼Ÿ

ä¸éœ€è¦ã€‚Firestore Security Rules æ˜¯åœ¨ Firebase å¾Œç«¯ç”Ÿæ•ˆçš„ï¼Œè®Šæ›´å¾Œç«‹å³ç”Ÿæ•ˆã€‚

### Q4: å¦‚æœéœ€è¦æ¯å€‹äººæœ‰è‡ªå·±çš„è³‡æ–™æ€éº¼è¾¦ï¼Ÿ

éœ€è¦ä¿®æ”¹è³‡æ–™çµæ§‹å’Œè¦å‰‡ï¼š
1. æ”¹ç”¨ `/users/{uid}/data/` è·¯å¾‘
2. ä¿®æ”¹ `src/services/firestoreService.ts` çš„è·¯å¾‘é‚è¼¯
3. ä¿®æ”¹è¦å‰‡å…è¨±æ¯å€‹äººå­˜å–è‡ªå·±çš„è·¯å¾‘

### Q5: ç‚ºä»€éº¼è·¯å¾‘æ˜¯ `/shared/data/{collection}` è€Œä¸æ˜¯ `/shared/{collection}`ï¼Ÿ

Firestore çš„è·¯å¾‘å¿…é ˆæ˜¯**å¶æ•¸æ®µ**ï¼ˆcollection â†’ document â†’ collection â†’ document...ï¼‰ã€‚
- âŒ `/shared/courses` - 3 æ®µï¼ˆå¥‡æ•¸ï¼‰ï¼Œæœƒå ±éŒ¯
- âœ… `/shared/data/courses` - 4 æ®µï¼ˆå¶æ•¸ï¼‰ï¼Œæ­£ç¢º

---

## ğŸ“ è¦å‰‡è§£æ

```javascript
// 1. æŒ‡å®šè¦å‰‡ç‰ˆæœ¬
rules_version = '2';

// 2. å®šç¾© Firestore è¦å‰‡
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 3. åŒ¹é…å…±ç”¨è³‡æ–™è·¯å¾‘
    match /shared/{document=**} {
      //               â†‘
      //               {document=**} è¡¨ç¤ºåŒ¹é…æ‰€æœ‰å­æ–‡ä»¶å’Œå­é›†åˆ
      
      // 4. æ¬Šé™æª¢æŸ¥ï¼šå¿…é ˆç™»å…¥ ä¸” email åœ¨ç™½åå–®ä¸­
      allow read, write: if request.auth != null && 
                           request.auth.token.email in ['...'];
    }
    
    // 5. é è¨­ï¼šç¦æ­¢æ‰€æœ‰å…¶ä»–å­˜å–
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

### è¦å‰‡èªªæ˜

| æ¢ä»¶ | èªªæ˜ |
|------|------|
| `request.auth != null` | ä½¿ç”¨è€…å¿…é ˆå·²ç™»å…¥ Firebase Authentication |
| `request.auth.token.email` | å–å¾—ä½¿ç”¨è€…çš„ Emailï¼ˆå¾ Google ç™»å…¥ï¼‰ |
| `in [...]` | æª¢æŸ¥ Email æ˜¯å¦åœ¨ç™½åå–®é™£åˆ—ä¸­ |
| `{document=**}` | åŒ¹é…æ‰€æœ‰å­è·¯å¾‘ï¼ˆåŒ…å«å­é›†åˆå’Œæ–‡ä»¶ï¼‰ |

---

## ğŸ› é™¤éŒ¯ç¶“æ­·èˆ‡å¿ƒå¾—

### å•é¡Œ 1ï¼šè³‡æ–™è·¯å¾‘éŒ¯èª¤ï¼ˆæœ€é—œéµï¼‰

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Invalid document reference. Document references must have an even number of segments, 
but shared/courses/fri-1 has 3.
```

**åŸå› **ï¼šFirestore è·¯å¾‘å¿…é ˆæ˜¯å¶æ•¸æ®µï¼ˆcollection/document/collection/document...ï¼‰ï¼Œä½†æˆ‘å€‘ä½¿ç”¨äº† `/shared/courses/{id}`ï¼ˆ3 æ®µï¼Œå¥‡æ•¸ï¼‰ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šæ”¹ç‚º `/shared/data/courses/{id}`ï¼ˆ4 æ®µï¼Œå¶æ•¸ï¼‰ã€‚

**ä¿®æ”¹çš„æª”æ¡ˆ**ï¼š
- `src/services/firestoreService.ts` - æ‰€æœ‰è·¯å¾‘å¾ `/users/{uid}/{collection}` æ”¹ç‚º `/shared/data/{collection}`
- `src/hooks/useScheduleData.ts` - è·¯å¾‘å¸¸æ•¸å¾ `'shared'` æ”¹ç‚º `'shared'`ï¼ˆä½†å¯¦éš›è·¯å¾‘åœ¨ service å±¤è™•ç†ï¼‰
- `src/hooks/useSalaryData.ts` - åŒä¸Š

### å•é¡Œ 2ï¼šæ¬Šé™éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
FirebaseError: [code=permission-denied]: Missing or insufficient permissions.
```

**åŸå› **ï¼š
1. Firestore Rules æœªæ­£ç¢ºè¨­å®š
2. Email ä¸åœ¨ç™½åå–®ä¸­
3. Rules å°šæœªç™¼å¸ƒ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªåœ¨ Firebase Console é»é¸ã€Œç™¼å¸ƒã€æŒ‰éˆ•
2. ç¢ºèª Email åœ°å€èˆ‡ç™»å…¥çš„ Google å¸³è™Ÿå®Œå…¨ä¸€è‡´
3. é‡æ–°æ•´ç†é é¢è®“æ–°è¦å‰‡ç”Ÿæ•ˆ

### å•é¡Œ 3ï¼šè³‡æ–™é·ç§»éœ€æ±‚

**æƒ…å¢ƒ**ï¼šèˆŠè³‡æ–™åœ¨ `/users/{uid}/` è·¯å¾‘ä¸‹ï¼Œä½†æ–°ç³»çµ±ä½¿ç”¨ `/shared/data/` è·¯å¾‘ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. å»ºç«‹æš«æ™‚çš„é·ç§»å·¥å…·ï¼ˆ`/migration` é é¢ï¼‰
2. è¨­å®šæš«æ™‚çš„ Firestore Rules å…è¨±è®€å–èˆŠè·¯å¾‘
3. æ‰¹æ¬¡è¤‡è£½è³‡æ–™åˆ°æ–°è·¯å¾‘
4. é·ç§»å®Œæˆå¾Œåˆªé™¤é·ç§»å·¥å…·

**é·ç§»å®Œæˆå¾Œå·²åˆªé™¤**ï¼š
- `src/app/migration/page.tsx` - é·ç§»å·¥å…·é é¢
- `src/app/debug/page.tsx` - é™¤éŒ¯è³‡è¨Šé é¢
- `src/components/UnauthorizedPrompt.tsx` - æœªæˆæ¬Šæç¤ºï¼ˆä¸éœ€è¦ï¼ŒFirestore æœƒç›´æ¥æ“‹ï¼‰

### æ ¸å¿ƒè¨­è¨ˆæ±ºç­–

#### 1. **ç‚ºä»€éº¼é¸æ“‡å…±ç”¨è³‡æ–™ï¼Ÿ**

**å„ªé»**ï¼š
- ç°¡åŒ–æ¬Šé™ç®¡ç†ï¼ˆæ‰€æœ‰äººéƒ½æ˜¯å¹³ç­‰çš„ï¼‰
- ä¸éœ€è¦è¤‡é›œçš„è·¨ä½¿ç”¨è€…è³‡æ–™è®€å–é‚è¼¯
- é©åˆå®¶åº­å…±ç”¨æƒ…å¢ƒï¼ˆèª²è¡¨ã€ç­è¡¨æœ¬ä¾†å°±æ˜¯å…¨å®¶å…±ç”¨ï¼‰

**ç¼ºé»**ï¼š
- æ‰€æœ‰äººéƒ½å¯ä»¥ç·¨è¼¯æ‰€æœ‰è³‡æ–™
- ç„¡æ³•å€åˆ†èª°æ–°å¢/ä¿®æ”¹äº†ä»€éº¼

#### 2. **ç‚ºä»€éº¼æ¬Šé™æ§åˆ¶å®Œå…¨ç”± Firestore Rules è™•ç†ï¼Ÿ**

**å„ªé»**ï¼š
- å‰ç«¯ç„¡éœ€ç¶­è­· Email ç™½åå–®ï¼ˆé¿å…æ•æ„Ÿè³‡è¨Šå¤–æ´©ï¼‰
- å¾Œç«¯ä¿è­‰å®‰å…¨æ€§ï¼ˆå‰ç«¯ç„¡æ³•ç¹éï¼‰
- è¦å‰‡è®Šæ›´å³æ™‚ç”Ÿæ•ˆï¼Œç„¡éœ€é‡æ–°éƒ¨ç½²

**ç¼ºé»**ï¼š
- å‰ç«¯ç„¡æ³•é å…ˆçŸ¥é“ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™ï¼ˆä½†é€™æ˜¯å¥½äº‹ï¼Œå®‰å…¨æ€§æ›´é«˜ï¼‰
- éœ€è¦åœ¨ Firebase Console æ‰‹å‹•ç®¡ç†ç™½åå–®

#### 3. **ç°¡åŒ–çš„ permissions.ts**

åŸæœ¬æƒ³è¦åœ¨å‰ç«¯å¯¦ä½œè¤‡é›œçš„æ¬Šé™ç³»çµ±ï¼ˆowner/readonly/unauthorizedï¼‰ï¼Œä½†ç™¼ç¾ï¼š
- Firestore Rules å·²ç¶“æä¾›å®Œæ•´çš„æ¬Šé™æ§åˆ¶
- å‰ç«¯åªéœ€è¦æª¢æŸ¥ã€Œæ˜¯å¦ç™»å…¥ã€å³å¯
- éåº¦çš„å‰ç«¯æ¬Šé™æª¢æŸ¥åè€Œå¢åŠ è¤‡é›œåº¦

**æœ€çµ‚æ–¹æ¡ˆ**ï¼š`permissions.ts` åªä¿ç•™ `isAuthenticated()` æª¢æŸ¥ï¼Œå…¶ä»–äº¤çµ¦ Firestore Rulesã€‚

---

## ğŸš¨ å®‰å…¨æé†’

1. **åªæ–°å¢ä¿¡ä»»çš„å®¶äºº**ï¼šæ‰€æœ‰ç™½åå–®æˆå“¡éƒ½å¯ä»¥è®€å¯«æ‰€æœ‰è³‡æ–™
2. **å®šæœŸæª¢æŸ¥è¦å‰‡**ï¼šç¢ºä¿åªæœ‰æˆæ¬Šçš„ä½¿ç”¨è€…åœ¨æ¸…å–®ä¸­
3. **æ¸¬è©¦è¦å‰‡**ï¼šæ¯æ¬¡ä¿®æ”¹è¦å‰‡å¾Œéƒ½æ‡‰è©²æ¸¬è©¦
4. **å‚™ä»½è³‡æ–™**ï¼šé‡è¦è³‡æ–™æ‡‰è©²å®šæœŸå‚™ä»½
5. **ä¸è¦å…¬é–‹ Firebase è¨­å®š**ï¼š`.env.local` ä¸è¦æäº¤åˆ° Gitï¼ˆä½† API Key æš´éœ²åœ¨å‰ç«¯æ˜¯æ­£å¸¸çš„ï¼‰

---

## ğŸ“š ç›¸é—œè³‡æº

- [Firebase Security Rules å®˜æ–¹æ–‡ä»¶](https://firebase.google.com/docs/firestore/security/get-started)
- [è¦å‰‡æ¸¬è©¦å·¥å…·](https://firebase.google.com/docs/rules/simulator)
- [å¸¸è¦‹è¦å‰‡ç¯„ä¾‹](https://firebase.google.com/docs/firestore/security/rules-examples)
- [Firestore è³‡æ–™çµæ§‹æœ€ä½³å¯¦è¸](https://firebase.google.com/docs/firestore/data-model)

---

## ğŸ“ å­¸ç¿’é‡é»

1. **Firestore è·¯å¾‘å¿…é ˆæ˜¯å¶æ•¸æ®µ** - é€™æ˜¯æœ€å®¹æ˜“è¸©çš„å‘
2. **Rules æ˜¯ç¬¬ä¸€é“é˜²ç·š** - å‰ç«¯æ¬Šé™æª¢æŸ¥åªæ˜¯ UXï¼ŒçœŸæ­£çš„å®‰å…¨åœ¨å¾Œç«¯
3. **æ¸¬è©¦ Rules çš„é‡è¦æ€§** - åœ¨ Firebase Console æœ‰ Rules Simulator å¯ä»¥æ¸¬è©¦
4. **è³‡æ–™é·ç§»éœ€è¬¹æ…** - å…ˆå‚™ä»½ï¼Œå†é·ç§»ï¼Œæœ€å¾Œé©—è­‰

---

**å®Œæˆè¨­å®šå¾Œï¼Œä½ çš„æ‡‰ç”¨ç¨‹å¼å°‡å…·å‚™å®Œæ•´çš„æ¬Šé™æ§åˆ¶æ©Ÿåˆ¶ï¼** ğŸ‰
