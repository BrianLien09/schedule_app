# ğŸ” Firestore Security Rules æ›´æ–°æŒ‡å—

## æ–°å¢éŠæˆ²æ”»ç•¥è³‡æ–™æ¬Šé™

### ğŸ“‹ éœ€è¦åŸ·è¡Œçš„æ“ä½œ

1. å‰å¾€ [Firebase Console](https://console.firebase.google.com/)
2. é¸æ“‡ä½ çš„å°ˆæ¡ˆ
3. å·¦å´é¸å–®ï¼š**Firestore Database** â†’ **è¦å‰‡**
4. å°‡ä»¥ä¸‹è¦å‰‡åŠ å…¥ç¾æœ‰è¦å‰‡ä¸­

---

## ğŸ†• æ–°å¢çš„è¦å‰‡

åœ¨ç¾æœ‰çš„ `rules_version = '2';` å€å¡Šä¸­ï¼Œæ‰¾åˆ° `/shared/data/` ç›¸é—œè¦å‰‡ï¼Œæ–°å¢ä»¥ä¸‹å…§å®¹ï¼š

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ç™½åå–®ï¼ˆè«‹æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´ï¼‰
    function isWhitelisted() {
      return request.auth != null && request.auth.token.email in [
        'brian.cheng.tw@gmail.com',
        'sherry931025@gmail.com',
        // åœ¨æ­¤æ–°å¢å…¶ä»–ç™½åå–®æˆå“¡çš„ Email
      ];
    }
    
    // ============================================================
    // ç¾æœ‰çš„ shared/data è¦å‰‡
    // ============================================================
    
    // èª²ç¨‹è³‡æ–™
    match /shared/data/courses/{courseId} {
      allow read, write: if isWhitelisted();
    }
    
    // æ‰“å·¥ç­è¡¨
    match /shared/data/workShifts/{shiftId} {
      allow read, write: if isWhitelisted();
    }
    
    // è–ªè³‡è¨˜éŒ„
    match /shared/data/salaryRecords/{recordId} {
      allow read, write: if isWhitelisted();
    }
    
    // é‡è¦äº‹ä»¶
    match /shared/data/events/{eventId} {
      allow read, write: if isWhitelisted();
    }
    
    // ============================================================
    // ğŸ†• éŠæˆ²æ”»ç•¥è³‡æ–™ï¼ˆæ–°å¢ï¼‰
    // ============================================================
    
    match /shared/data/gameGuides/{guideId} {
      // æ‰€æœ‰ç™½åå–®æˆå“¡å¯è®€å–
      allow read: if isWhitelisted();
      
      // æ‰€æœ‰ç™½åå–®æˆå“¡å¯æ–°å¢/ä¿®æ”¹/åˆªé™¤ï¼ˆå…±åŒç®¡ç†ï¼‰
      allow create, update, delete: if isWhitelisted();
    }
  }
}
```

---

## âœ… é©—è­‰è¦å‰‡

è¨­å®šå®Œæˆå¾Œï¼Œè«‹åŸ·è¡Œä»¥ä¸‹é©—è­‰ï¼š

### 1. è¦å‰‡æ¨¡æ“¬å™¨æ¸¬è©¦ï¼ˆFirebase Console å…§å»ºï¼‰

åœ¨ Firestore è¦å‰‡é é¢é»æ“Šã€Œè¦å‰‡æ“å ´ã€ï¼Œæ¸¬è©¦ä»¥ä¸‹æƒ…å¢ƒï¼š

**æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šè®€å–æ¬Šé™**
```
ä½ç½®ï¼š/shared/data/gameGuides/test123
æ“ä½œï¼šget
èªè­‰ï¼šå·²ç™»å…¥ï¼ˆä½ çš„ Emailï¼‰
é æœŸçµæœï¼šâœ… å…è¨±
```

**æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šå¯«å…¥æ¬Šé™**
```
ä½ç½®ï¼š/shared/data/gameGuides/test123
æ“ä½œï¼šcreate
èªè­‰ï¼šå·²ç™»å…¥ï¼ˆä½ çš„ Emailï¼‰
é æœŸçµæœï¼šâœ… å…è¨±
```

**æ¸¬è©¦æ¡ˆä¾‹ 3ï¼šæœªç™»å…¥æ‹’çµ•**
```
ä½ç½®ï¼š/shared/data/gameGuides/test123
æ“ä½œï¼šget
èªè­‰ï¼šæœªç™»å…¥
é æœŸçµæœï¼šâŒ æ‹’çµ•
```

### 2. å¯¦éš›æ¸¬è©¦

1. **åŸ·è¡Œé–‹ç™¼ä¼ºæœå™¨**
   ```bash
   npm run dev
   ```

2. **ç™»å…¥ä½ çš„å¸³è™Ÿ**
   - å‰å¾€ http://localhost:3000/login
   - ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥

3. **æ¸¬è©¦è³‡æ–™é·ç§»**
   - å‰å¾€ http://localhost:3000/games/migration
   - é»æ“Šã€Œé–‹å§‹é·ç§»ã€
   - ç¢ºèªè³‡æ–™æˆåŠŸåŒ¯å…¥

4. **æ¸¬è©¦æ”»ç•¥ç®¡ç†**
   - å‰å¾€ http://localhost:3000/games
   - é»æ“Šã€Œç·¨è¼¯æ¨¡å¼ã€
   - å˜—è©¦æ–°å¢/ä¿®æ”¹/åˆªé™¤æ”»ç•¥
   - ç¢ºèªæ‰€æœ‰æ“ä½œæ­£å¸¸é‹ä½œ

---

## ğŸ›¡ï¸ å®‰å…¨æ€§èªªæ˜

### ç‚ºä»€éº¼æ¡ç”¨å…±ç”¨è³‡æ–™æ¶æ§‹ï¼Ÿ

1. **åœ˜éšŠå”ä½œéœ€æ±‚**
   - ä½ å€‘çš„å°ˆæ¡ˆæ˜¯å…±äº«è¡Œäº‹æ›†/èª²è¡¨ç³»çµ±
   - éŠæˆ²æ”»ç•¥åŒæ¨£é©åˆåœ˜éšŠå…±åŒç¶­è­·

2. **è³‡æ–™åŒæ­¥**
   - æ‰€æœ‰ç™½åå–®æˆå“¡çœ‹åˆ°ç›¸åŒçš„æ”»ç•¥è³‡æ–™
   - é¿å…è³‡æ–™ä¸ä¸€è‡´

3. **æ¬Šé™æ§åˆ¶**
   - å®Œå…¨ç”± Firestore Rules æ§ç®¡
   - å‰ç«¯ç„¡æ³•ç¹éæ¬Šé™æª¢æŸ¥

### æ½›åœ¨é¢¨éšªèˆ‡æ‡‰å°

| é¢¨éšª | æ‡‰å°æªæ–½ |
|------|----------|
| èª¤åˆªè³‡æ–™ | å‰ç«¯æœ‰ç¢ºèªå°è©±æ¡† + å¯è€ƒæ…®åŠ å…¥è»Ÿåˆªé™¤ï¼ˆæ¨™è¨˜ç‚ºå·²åˆªé™¤è€ŒéçœŸæ­£åˆªé™¤ï¼‰ |
| æƒ¡æ„ä¿®æ”¹ | ç™½åå–®æ©Ÿåˆ¶ + å¯å•Ÿç”¨ Firestore è‡ªå‹•å‚™ä»½ |
| æ¬Šé™å¤–æ´© | å®šæœŸæª¢æŸ¥ç™½åå–®æˆå“¡ + ä½¿ç”¨å¼·å¯†ç¢¼ä¿è­· Google å¸³è™Ÿ |

---

## ğŸ“Š è³‡æ–™è·¯å¾‘çµæ§‹

```
Firestore Database
â””â”€â”€ /shared (collection)
    â””â”€â”€ /data (document)
        â”œâ”€â”€ /courses/{courseId}           # ç¾æœ‰ï¼šèª²ç¨‹è³‡æ–™
        â”œâ”€â”€ /workShifts/{shiftId}         # ç¾æœ‰ï¼šæ‰“å·¥ç­è¡¨
        â”œâ”€â”€ /salaryRecords/{recordId}     # ç¾æœ‰ï¼šè–ªè³‡è¨˜éŒ„
        â”œâ”€â”€ /events/{eventId}             # ç¾æœ‰ï¼šé‡è¦äº‹ä»¶
        â””â”€â”€ /gameGuides/{guideId} ğŸ†•      # æ–°å¢ï¼šéŠæˆ²æ”»ç•¥
            â”œâ”€â”€ gameId: string
            â”œâ”€â”€ version: string (optional)
            â”œâ”€â”€ title: string
            â”œâ”€â”€ subtitle: string (optional)
            â”œâ”€â”€ url: string
            â”œâ”€â”€ resonanceCode: string (optional)
            â”œâ”€â”€ category: string
            â”œâ”€â”€ priority: number (1-5)
            â”œâ”€â”€ tags: array
            â”œâ”€â”€ completed: boolean
            â”œâ”€â”€ order: number
            â”œâ”€â”€ createdAt: timestamp
            â””â”€â”€ updatedAt: timestamp
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šæ¬Šé™æ‹’çµ•éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯**ï¼š`Missing or insufficient permissions`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªä½ çš„ Email å·²åŠ å…¥ç™½åå–®
2. é‡æ–°ç™»å…¥ï¼ˆæ¸…é™¤å¿«å–ï¼‰
3. æª¢æŸ¥ Firebase Console è¦å‰‡æ˜¯å¦æ­£ç¢ºå„²å­˜

### å•é¡Œ 2ï¼šè³‡æ–™é·ç§»å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**ï¼šæ‰¹æ¬¡å¯«å…¥å¤±æ•—

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª Firestore è¦å‰‡å·²æ›´æ–°ä¸¦ç™¼å¸ƒ
2. æª¢æŸ¥ç¶²è·¯é€£ç·š
3. æŸ¥çœ‹ Firebase Console çš„ã€Œä½¿ç”¨æƒ…æ³ã€æ˜¯å¦è¶…éé…é¡

### å•é¡Œ 3ï¼šç„¡æ³•çœ‹åˆ°æ”»ç•¥è³‡æ–™

**å¯èƒ½åŸå› **ï¼š
- å°šæœªåŸ·è¡Œè³‡æ–™é·ç§»
- Firestore è¦å‰‡æœªæ›´æ–°
- ç™»å…¥çš„å¸³è™Ÿä¸åœ¨ç™½åå–®ä¸­

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. å‰å¾€ `/games/migration` åŸ·è¡Œè³‡æ–™é·ç§»
2. ç¢ºèªè¦å‰‡å·²æ­£ç¢ºè¨­å®š
3. ä½¿ç”¨ç™½åå–®ä¸­çš„å¸³è™Ÿç™»å…¥

---

## ğŸ“ å¾ŒçºŒå»ºè­°

### 1. å•Ÿç”¨ Firestore è‡ªå‹•å‚™ä»½

åœ¨ Firebase Consoleï¼š
- **Firestore Database** â†’ **å‚™ä»½**
- è¨­å®šæ¯æ—¥è‡ªå‹•å‚™ä»½

### 2. ç›£æ§è³‡æ–™ä½¿ç”¨é‡

å®šæœŸæª¢æŸ¥ï¼š
- æ–‡ä»¶æ•¸é‡
- è®€å–/å¯«å…¥æ¬¡æ•¸
- å„²å­˜ç©ºé–“

### 3. è€ƒæ…®å‡ç´šè¨ˆç•«

å¦‚æœåœ˜éšŠæˆå“¡å¢åŠ ï¼Œå¯è€ƒæ…®ä»¥ä¸‹å„ªåŒ–ï¼š
- å€‹äººåŒ–é€²åº¦è¿½è¹¤ï¼ˆcompleted æ¬„ä½æ”¹ç‚º Map çµæ§‹ï¼‰
- è§’è‰²æ¬Šé™åˆ†ç´šï¼ˆç·¨è¼¯è€… vs æª¢è¦–è€…ï¼‰
- è³‡æ–™ç‰ˆæœ¬æ§åˆ¶ï¼ˆè¨˜éŒ„ä¿®æ”¹æ­·å²ï¼‰

---

## âœ… æª¢æŸ¥æ¸…å–®

å®Œæˆä»¥ä¸‹é …ç›®å¾Œå³å¯é–‹å§‹ä½¿ç”¨ï¼š

- [ ] åœ¨ Firebase Console æ›´æ–° Firestore Security Rules
- [ ] ç™¼å¸ƒè¦å‰‡ï¼ˆé»æ“Šã€Œç™¼å¸ƒã€æŒ‰éˆ•ï¼‰
- [ ] ä½¿ç”¨è¦å‰‡æ¨¡æ“¬å™¨æ¸¬è©¦
- [ ] åŸ·è¡Œé–‹ç™¼ä¼ºæœå™¨ä¸¦ç™»å…¥
- [ ] å‰å¾€ `/games/migration` åŸ·è¡Œè³‡æ–™é·ç§»
- [ ] å‰å¾€ `/games` é©—è­‰æ”»ç•¥é¡¯ç¤ºæ­£å¸¸
- [ ] æ¸¬è©¦ç·¨è¼¯æ¨¡å¼ï¼ˆæ–°å¢/ä¿®æ”¹/åˆªé™¤ï¼‰
- [ ] æ¸¬è©¦ç‰ˆæœ¬ç¯©é¸èˆ‡é€²åº¦çµ±è¨ˆ
- [ ] æ¸¬è©¦å®Œæˆæ¨™è¨˜åŠŸèƒ½

---

**æœ€å¾Œæé†’**ï¼š

è¨­å®šå®Œæˆå¾Œï¼Œè¨˜å¾—åœ¨ Firebase Console é»æ“Š **ã€Œç™¼å¸ƒã€** æŒ‰éˆ•ï¼Œè¦å‰‡æ‰æœƒç”Ÿæ•ˆï¼

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹æª¢æŸ¥ Browser Console çš„éŒ¯èª¤è¨Šæ¯ï¼Œæˆ–æŸ¥çœ‹ Firebase Console çš„ã€Œä½¿ç”¨æƒ…æ³å’Œè¨ˆè²»ã€é é¢ã€‚
